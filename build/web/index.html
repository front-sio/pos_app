<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Sales Management App">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Permissions Policy for Geolocation -->
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="sales_app">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Sales Management</title>
  <link rel="manifest" href="manifest.json">
  
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #2196F3;
      overflow: hidden;
    }
    
    /* Hide Flutter's default loading indicator */
    body > .flutter-loader,
    body > div[style*="position: absolute"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
  </style>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
  
  <script>
    // Real-time connectivity monitoring for web
    (function() {
      // Log initial state
      console.log('Initial connection state:', navigator.onLine ? 'Online' : 'Offline');
      
      // Monitor online/offline events
      window.addEventListener('online', function() {
        console.log('üü¢ Network: ONLINE');
        // Verify with actual connection test
        fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-cache' })
          .then(function() {
            console.log('‚úÖ Network: Internet connection verified');
          })
          .catch(function() {
            console.log('‚ö†Ô∏è Network: Connected but no internet access');
          });
      });
      
      window.addEventListener('offline', function() {
        console.log('üî¥ Network: OFFLINE');
      });
      
      // Periodic connection check every 3 seconds
      setInterval(function() {
        if (navigator.onLine) {
          // Quick connectivity test
          fetch('https://www.google.com/favicon.ico', { 
            mode: 'no-cors', 
            cache: 'no-cache',
            timeout: 3000 
          })
          .then(function() {
            // Connection is good
            if (!window._lastConnectionState) {
              console.log('‚úÖ Periodic check: Connection restored');
            }
            window._lastConnectionState = true;
          })
          .catch(function(error) {
            console.log('‚ö†Ô∏è Periodic check: Connection issue -', error.message);
            window._lastConnectionState = false;
          });
        } else {
          if (window._lastConnectionState !== false) {
            console.log('üî¥ Periodic check: Offline');
          }
          window._lastConnectionState = false;
        }
      }, 3000);
    })();
    
    // Service Worker Registration for version detection
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/flutter_service_worker.js').then(function(registration) {
          console.log('ServiceWorker registration successful');
          
          // Check for updates
          registration.addEventListener('updatefound', function() {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', function() {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New version available
                showUpdateNotification();
              }
            });
          });
        });
      });
      
      // Listen for controller change (new version activated)
      navigator.serviceWorker.addEventListener('controllerchange', function() {
        window.location.reload();
      });
    }
    
    function showUpdateNotification() {
      const div = document.createElement('div');
      div.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#2196F3;color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:99999;display:flex;align-items:center;gap:16px;font-family:system-ui;';
      div.innerHTML = '<div><strong>New Version Available!</strong><br><small>Kuna version mpya! Refresh ili kuona mabadiliko.</small></div><button onclick="window.location.reload()" style="background:white;color:#2196F3;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold;">Refresh</button><button onclick="this.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;padding:8px 16px;border-radius:4px;cursor:pointer;margin-left:8px;">Later</button>';
      document.body.appendChild(div);
    }
    
    // PWA Install Prompt for mobile browsers
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button after a delay (give user time to see the app)
      setTimeout(function() {
        showInstallPrompt();
      }, 10000); // 10 seconds
    });
    
    function showInstallPrompt() {
      // Check if on mobile
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (!isMobile || !deferredPrompt) return;
      
      // Check if already shown in this session
      if (sessionStorage.getItem('installPromptShown')) return;
      sessionStorage.setItem('installPromptShown', 'true');
      
      const div = document.createElement('div');
      div.id = 'installPrompt';
      div.style.cssText = 'position:fixed;bottom:20px;left:20px;right:20px;background:white;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:99999;font-family:system-ui;';
      div.innerHTML = '<div style="display:flex;align-items:center;gap:16px;"><div style="background:#2196F3;width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg></div><div style="flex:1;"><strong style="display:block;margin-bottom:4px;color:#333;">Install Sales App</strong><small style="color:#666;">Weka app kwenye simu yako kwa matumizi rahisi!</small></div></div><div style="display:flex;gap:12px;margin-top:16px;"><button onclick="installApp()" style="flex:1;background:#2196F3;color:white;border:none;padding:12px;border-radius:8px;font-weight:bold;cursor:pointer;">Install</button><button onclick="document.getElementById(\'installPrompt\').remove()" style="flex:1;background:#f5f5f5;color:#333;border:none;padding:12px;border-radius:8px;cursor:pointer;">Not Now</button></div>';
      document.body.appendChild(div);
    }
    
    function installApp() {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(function(choiceResult) {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
        document.getElementById('installPrompt')?.remove();
      });
    }
    
    // Track if app is installed
    window.addEventListener('appinstalled', function() {
      console.log('App installed successfully');
      deferredPrompt = null;
    });
  </script>
</body>
</html>
